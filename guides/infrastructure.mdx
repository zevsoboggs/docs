---
title: 'Техническая инфраструктура'
description: 'Как устроена система Love&Pay изнутри'
icon: 'server'
---

## Обзор архитектуры

Love&Pay построен на современном технологическом стеке, обеспечивающем высокую производительность, надёжность и безопасность платёжных операций.

<CardGroup cols={2}>
  <Card title="Redis" icon="bolt">
    Высокоскоростное кэширование данных
  </Card>
  <Card title="Hangfire" icon="clock">
    Надёжные фоновые задачи и очереди
  </Card>
  <Card title="Логирование" icon="file-lines">
    Полная запись всех операций
  </Card>
  <Card title="Аудит" icon="magnifying-glass">
    Автоматический контроль действий
  </Card>
</CardGroup>

## Кэширование (Redis)

Мы используем **Redis** для кэширования данных, что обеспечивает:

- **Мгновенный доступ** к часто запрашиваемым данным
- **Снижение нагрузки** на основную базу данных
- **Высокую доступность** сервиса даже при пиковых нагрузках

<Info>
  Благодаря Redis, повторные запросы к API обрабатываются в несколько раз быстрее.
</Info>

### Что кэшируется

| Данные | Время жизни кэша |
|--------|------------------|
| Информация о счетах | До изменения статуса |
| Данные партнёра | 5 минут |
| Курсы валют | 1 минута |
| Сессии KYC | До завершения |

## Очереди задач (Hangfire)

Для обработки фоновых задач используется **Hangfire** — надёжная система очередей с гарантированной доставкой.

### Типы фоновых задач

<AccordionGroup>
  <Accordion title="Проверка статуса платежей">
    Автоматическая проверка оплаты счетов через СБП с адаптивной периодичностью.
  </Accordion>
  <Accordion title="Отправка вебхуков">
    Гарантированная доставка уведомлений с повторными попытками при ошибках.
  </Accordion>
  <Accordion title="Истечение счетов">
    Автоматическое изменение статуса на EXPIRED по истечении времени.
  </Accordion>
  <Accordion title="KYC верификация">
    Обработка результатов проверки документов.
  </Accordion>
</AccordionGroup>

## Проверка платежей

Система автоматически проверяет статус каждого счёта с **адаптивной периодичностью**:

<Steps>
  <Step title="Первые 5 минут">
    Проверка каждые **30 секунд** — для быстрого подтверждения платежей
  </Step>
  <Step title="После 5 минут">
    Проверка каждые **2 минуты** — экономия ресурсов при длительном ожидании
  </Step>
  <Step title="Остановка проверки">
    Проверка прекращается когда:
    - Счёт оплачен (статус `PAID`)
    - Счёт истёк (статус `EXPIRED`)
    - Статус изменился на любой кроме `PENDING`
  </Step>
</Steps>

### Истечение счёта

<Warning>
  Через **1 час** после создания счёт автоматически получает статус `EXPIRED`. После этого оплата по нему невозможна.
</Warning>

При истечении счёта:
1. **ExpireWorker** меняет статус на `EXPIRED`
2. Отправляется **вебхук** партнёру с событием `INVOICE_EXPIRED`
3. QR-код становится недействительным

## Логирование

Все запросы к API и действия в системе **полностью логируются**:

<CardGroup cols={2}>
  <Card title="API запросы" icon="code">
    Метод, URL, параметры, время ответа, IP адрес
  </Card>
  <Card title="Платёжные операции" icon="credit-card">
    Создание счетов, изменение статусов, транзакции
  </Card>
  <Card title="Действия пользователей" icon="user">
    Вход в систему, изменение настроек, управление ключами
  </Card>
  <Card title="Системные события" icon="gear">
    Ошибки, предупреждения, информационные сообщения
  </Card>
</CardGroup>

### Что записывается

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "INFO",
  "action": "INVOICE_CREATED",
  "partnerId": "partner-uuid",
  "userId": "user-uuid",
  "ip": "192.168.1.1",
  "userAgent": "MyApp/1.0",
  "request": {
    "method": "POST",
    "path": "/api/v1/invoices",
    "duration": 45
  },
  "data": {
    "invoiceId": "inv-uuid",
    "amount": 150000
  }
}
```

## Автоматический аудит

Система проводит **автоматический аудит** всех действий для обеспечения безопасности и соответствия требованиям.

### Что отслеживается

| Категория | Действия |
|-----------|----------|
| **Безопасность** | Попытки входа, смена паролей, подозрительная активность |
| **API ключи** | Создание, удаление, использование, блокировки |
| **Финансы** | Все платёжные операции, изменения статусов |
| **Данные** | Изменения настроек, экспорт данных |
| **Доступ** | Кто, когда и откуда обращался к системе |

### Преимущества аудита

<CardGroup cols={3}>
  <Card title="Безопасность" icon="shield-check">
    Быстрое обнаружение подозрительной активности
  </Card>
  <Card title="Прозрачность" icon="eye">
    Полная история всех операций
  </Card>
  <Card title="Соответствие" icon="certificate">
    Выполнение требований регуляторов
  </Card>
</CardGroup>

<Info>
  Логи хранятся в защищённом хранилище и доступны для анализа в случае необходимости. При возникновении спорных ситуаций мы можем предоставить детальную информацию о любой операции.
</Info>

## Мониторинг

Мы круглосуточно мониторим:

- Доступность всех сервисов
- Время ответа API
- Очереди задач Hangfire
- Использование Redis кэша
- Аномальную активность

<Card title="Есть вопросы?" icon="comments" href="https://loveandpay.io">
  Напишите нам в онлайн-чат на **loveandpay.io** — мы расскажем подробнее о нашей инфраструктуре.
</Card>
